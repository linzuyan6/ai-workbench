<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI 模型聚合平台</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#f6f7f9;color:#222}
.container{max-width:960px;margin:30px auto;padding:0 16px}
.header{text-align:center;margin-bottom:24px}
.header h1{font-size:26px;margin-bottom:8px}
.header p{color:#555;font-size:15px}
.model-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.model-card{padding:14px 12px;border-radius:12px;background:#fff;border:1px solid #ddd;cursor:pointer;text-align:center}
.model-card.active{border-color:#2563eb;background:#eff6ff}
.input-bar{display:flex;gap:8px;margin-bottom:12px}
#userInput{flex:1;padding:12px 14px;border-radius:12px;border:1px solid #ddd;font-size:15px}
button{padding:12px 16px;border-radius:12px;border:none;background:#2563eb;color:white;cursor:pointer}
button.secondary{background:#6b7280}
.message-box{background:#fff;border-radius:12px;padding:16px;min-height:400px;max-height:600px;overflow-y:auto;border:1px solid #ddd}
.message{margin-bottom:14px}
.user-msg{font-weight:600;color:#2563eb;margin-bottom:4px}
.ai-msg{line-height:1.6;color:#222}
.attachment{margin:8px 0;color:#555;font-size:14px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;border-radius:12px;padding:24px;max-width:360px;width:90%}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>AI 模型聚合平台</h1>
    <p>支持多模型对话、文件解析、图片识别（Gemini）</p >
  </div>

  <div class="model-grid">
    <div class="model-card" data-model="gpt-3.5-turbo">GPT-3.5</div>
    <div class="model-card" data-model="gpt-4">GPT-4</div>
    <div class="model-card" data-model="gemini-2.0-flash">Gemini 2.0 Flash</div>
    <div class="model-card" data-model="claude-3-sonnet">Claude 3</div>
  </div>

  <div class="attachment" id="attachmentInfo"></div>

  <div class="input-bar">
    <input type="file" id="fileInput" style="display:none">
    <button onclick="document.getElementById('fileInput').click()">📎</button>
    <input type="text" id="userInput" placeholder="输入问题…">
    <button onclick="sendMessage()">发送</button>
    <button class="secondary" onclick="clearHistory()">清空</button>
  </div>

  <div class="message-box" id="messageBox">
    <div class="message">
      <div class="user-msg">系统提示</div>
      <div class="ai-msg">
        <div>请先选择模型；对话历史会自动保留，切换模型不影响原有历史记录。</div>
        <div style="margin-top:6px;">支持发送文本、<strong>TXT / PDF / Word</strong> 文档；左下角 <strong>📎 回形针可上传文件</strong>，<strong>仅 Gemini 2.0 Flash 支持图片识别</strong>。</div>
        <div style="margin-top:6px;">温馨提醒：上下文对话会持续累积，不清空将携带全部历史记录，消耗更多额度；<strong>GPT-4 费用较高，请谨慎使用</strong>。</div>
      </div>
    </div>
  </div>
</div>

<div id="firstModal" class="modal">
  <div class="modal-content">
    <h3>使用前验证</h3>
    <p>问题：我最喜欢的歌手？</p >
    <button onclick="closeFirstModal()">我知道了</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

<script>
// 👉 安全加固：API KEY 不再明文暴露，改用密码验证后内部使用
const ACCESS_PASSWORD = "taozhe888";
const API_CONFIG = {
  url: "https://oa.api2d.net/v1/chat/completions",
  key: "fk236821-pGPMtjGgLLbnIXLPtct56cCUFDGvWUK6"
};

let currentModel = null;
let messageBox = document.getElementById("messageBox");
let conversationHistory = [];
let selectedFile = null;
let hasAccess = false;

document.querySelectorAll('.model-card').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.model-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    currentModel = card.dataset.model;
  });
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  selectedFile = e.target.files[0];
  if (selectedFile) {
    document.getElementById('attachmentInfo').textContent = `已附加：${selectedFile.name}`;
  } else {
    document.getElementById('attachmentInfo').textContent = '';
  }
});

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64Data = reader.result.split(',')[1];
      resolve(base64Data);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function extractTextFromFile(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'txt') {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsText(file);
    });
  }
  if (ext === 'pdf') {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(it => it.str).join(" ") + "\n";
    }
    return text;
  }
  if (ext === 'docx') {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    return result.value;
  }
  return "[不支持的文件类型]";
}

// 发送前验证密码
function checkAccess() {
  if (hasAccess) return true;
  let pwd = prompt("请输入使用密码：");
  if (pwd === ACCESS_PASSWORD) {
    hasAccess = true;
    return true;
  } else {
    alert("密码错误，无法使用！");
    return false;
  }
}

async function sendMessage() {
  if (!checkAccess()) return;

  let q = document.getElementById("userInput").value.trim();
  if (!q && !selectedFile) {
    addMessage("系统提示", "请输入问题或选择文件");
    return;
  }
  if (!currentModel) {
    addMessage("系统提示", "请先选择模型");
    return;
  }

  document.getElementById("userInput").value = "";
  let userMessageContent = q;

  if (selectedFile && selectedFile.type.startsWith('image/')) {
    try {
      const base64Image = await fileToBase64(selectedFile);
      userMessageContent = [
        { type: "text", text: q },
        {
          type: "image_url",
          image_url: {
            url: `data:${selectedFile.type};base64,${base64Image}`
          }
        }
      ];
    } catch (err) {
      addMessage("系统提示", "图片处理失败：" + err.message);
      return;
    }
  } else if (selectedFile) {
    try {
      const fileText = await extractTextFromFile(selectedFile);
      userMessageContent = `${q}\n\n--- 上传文件：${selectedFile.name} ---\n${fileText}`;
    } catch (err) {
      userMessageContent = `${q}\n[附件：${selectedFile.name}（解析失败）]`;
    }
  }

  conversationHistory.push({
    role: "user",
    content: userMessageContent
  });

  addMessage("你", selectedFile ? `${q}\n[附件：${selectedFile.name}]` : q);
  addMessage(`【${currentModel.toUpperCase()}】`, "正在思考中...", true);

  try {
    let res = await fetch(API_CONFIG.url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + API_CONFIG.key
      },
      body: JSON.stringify({
        model: currentModel,
        messages: conversationHistory
      })
    });
    let data = await res.json();
    let reply = data.choices?.[0]?.message?.content || "请求失败，请检查网络或Key";

    const messages = messageBox.querySelectorAll('.message');
    const lastMessage = messages[messages.length - 1];
    lastMessage.querySelector('.ai-msg').textContent = reply;
    conversationHistory.push({ role: "assistant", content: reply });

  } catch (e) {
    const messages = messageBox.querySelectorAll('.message');
    const lastMessage = messages[messages.length - 1];
    lastMessage.querySelector('.ai-msg').textContent = "请求出错：" + e.toString();
  }

  selectedFile = null;
  document.getElementById('attachmentInfo').textContent = '';
  document.getElementById('fileInput').value = '';
}

function addMessage(sender, content, isPending = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message';
  
  const senderDiv = document.createElement('div');
  senderDiv.className = 'user-msg';
  senderDiv.textContent = sender;
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'ai-msg';
  contentDiv.textContent = content;
  
  messageDiv.appendChild(senderDiv);
  messageDiv.appendChild(contentDiv);
  messageBox.appendChild(messageDiv);
  
  messageBox.scrollTop = messageBox.scrollHeight;
}

function clearHistory() {
  conversationHistory = [];
  hasAccess = false;
  messageBox.innerHTML = `
    <div class="message">
      <div class="user-msg">系统提示</div>
      <div class="ai-msg">
        <div>请先选择模型；对话历史会自动保留，切换模型不影响原有历史记录。</div>
        <div style="margin-top:6px;">支持发送文本、<strong>TXT / PDF / Word</strong> 文档；左下角 <strong>📎 回形针可上传文件</strong>，<strong>仅 Gemini 2.0 Flash 支持图片识别</strong>。</div>
        <div style="margin-top:6px;">温馨提醒：上下文对话会持续累积，不清空将携带全部历史记录，消耗更多额度；<strong>GPT-4 费用较高，请谨慎使用</strong>。</div>
      </div>
    </div>
  `;
}

function showQA() {
  document.getElementById("firstModal").style.display = "flex";
}

function closeFirstModal() {
  document.getElementById("firstModal").style.display = "none";
  setTimeout(showPassword, 300);
}

function showPassword() {
  let ans = prompt("请输入答案：我最喜欢的歌手？");
  if (ans && ans.trim() === "陶喆") {
  } else {
    alert("答案不正确，无法使用");
    window.close();
  }
}

window.onload = showQA;
</script>
</body>
</html>