<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>小林的 AI 工作台</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  body {
    background: linear-gradient(135deg, #d4e8ff 0%, #f8f9fa 50%, #fad7e0 100%);
    color: #333;
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
  }
  .title {
    font-size: 36px;
    font-weight: 600;
    margin-bottom: 40px;
    text-align: center;
    color: #2c3e50;
  }

  .model-section {
    margin-bottom: 40px;
  }
  .section-title {
    font-size: 16px;
    color: #007aff;
    font-weight: 600;
    margin-bottom: 20px;
  }
  .model-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .model-card {
    flex: 1;
    min-width: 180px;
    padding: 30px 20px;
    border-radius: 16px;
    border: 1px solid #e0e6ed;
    background: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .model-card:hover {
    border-color: #007aff;
    box-shadow: 0 10px 25px rgba(0,122,255,0.16);
    transform: translateY(-3px);
  }
  .model-card.active {
    border-color: #007aff;
    background: #f0f7ff;
  }
  .model-icon {
    font-size: 36px;
    margin-bottom: 12px;
  }
  .model-name {
    font-size: 16px;
    font-weight: 500;
  }
  .free-models {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .free-btn {
    padding: 8px 16px;
    border-radius: 20px;
    background: #fff;
    border: 1px solid #e0e6ed;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .free-btn:hover {
    background: #f5f5f5;
  }
  .input-area {
    margin-top: 30px;
  }
  .input-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
    align-items: center;
  }
  #userInput {
    flex: 1;
    padding: 14px 18px;
    border-radius: 24px;
    border: 1px solid #e0e6ed;
    font-size: 15px;
    background: #fff;
  }
  button {
    padding: 14px 20px;
    border-radius: 24px;
    border: none;
    background: #007aff;
    color: white;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }
  button.secondary {
    background: #6c757d;
  }
  button:hover {
    opacity: 0.9;
  }
  .attachment {
    color: #666;
    font-size: 14px;
    margin-bottom: 8px;
  }
  .message-box {
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    min-height: 300px;
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #e0e6ed;
  }
  .message {
    margin-bottom: 16px;
  }
  .user-msg {
    font-weight: 600;
    color: #007aff;
    margin-bottom: 4px;
  }
  .ai-msg {
    line-height: 1.6;
    color: #333;
    font-size: 14px;
  }
  .modal {
    position: fixed;
    left:0; top:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: white;
    border-radius: 16px;
    padding: 24px;
    max-width: 360px;
    width: 90%;
    text-align: center;
  }
</style>
</head>
<body>

<div class="title">小林的 AI 工作台</div>

<div class="model-section">
  <div class="section-title">计费模型</div>
  <div class="model-row">
    <div class="model-card" data-model="gpt-3.5-turbo">
      <div class="model-icon">🟢</div>
      <div class="model-name">GPT-3.5</div>
    </div>
    <div class="model-card" data-model="gpt-4">
      <div class="model-icon">⚫</div>
      <div class="model-name">GPT-4</div>
    </div>
    <div class="model-card" data-model="gemini-2.0-flash">
      <div class="model-icon">🟠</div>
      <div class="model-name">Gemini 2.0 Flash</div>
    </div>
  </div>
</div>

<div class="model-section">
  <div class="section-title">免费模型</div>
  <div class="free-models">
    <button class="free-btn" data-url="https://www.doubao.com/">豆包</button>
    <button class="free-btn" data-url="https://www.deepseek.com/">DeepSeek</button>
    <button class="free-btn" data-url="https://qianwen.aliyun.com/">千问</button>
    <button class="free-btn" data-url="https://kimi.moonshot.cn/">Kimi</button>
  </div>
</div>

<div class="input-area">
  <div class="attachment" id="attachmentInfo"></div>
  <div class="input-bar">
    <input type="file" id="fileInput" style="display:none">
    <button onclick="document.getElementById('fileInput').click()">📎</button>
    <input type="text" id="userInput" placeholder="输入问题…">
    <button onclick="sendMessage()">发送</button>
    <button class="secondary" onclick="clearHistory()">清空</button>
  </div>
  <div class="message-box" id="messageBox">
    <div class="message">
      <div class="user-msg">系统提示</div>
      <div class="ai-msg">
        <div>请先选择模型；对话历史会自动保留，切换模型不影响原有历史记录。</div>
        <div style="margin-top:6px;">支持发送文本、<strong>TXT / PDF / Word</strong> 文档；左下角 <strong>📎 回形针可上传文件</strong>，<strong>仅 Gemini 2.0 Flash 支持图片识别</strong>。</div>
        <div style="margin-top:6px;">温馨提醒：上下文对话会持续累积，不清空将携带全部历史记录，消耗更多额度；<strong>GPT-4 费用较高，请谨慎使用</strong>。</div>
      </div>
    </div>
  </div>
</div>

<div id="firstModal" class="modal">
  <div class="modal-content">
    <h3>使用前验证</h3>
    <p>问题：我最喜欢的歌手？</p >
    <button onclick="closeFirstModal()">我知道了</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

<script>
const API_CONFIG = {
  url: "https://oa.api2d.net/v1/chat/completions",
  key: "fk236821-pGPMtjGgLLbnIXLPtct56cCUFDGvWUK6"
};

let currentModel = null;
let messageBox = document.getElementById("messageBox");
let conversationHistory = [];
let selectedFile = null;

document.querySelectorAll('.model-card').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.model-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    currentModel = card.dataset.model;
  });
});

document.querySelectorAll('.free-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    window.open(btn.dataset.url, '_blank');
  });
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  selectedFile = e.target.files[0];
  if (selectedFile) {
    document.getElementById('attachmentInfo').textContent = `已附加：${selectedFile.name}`;
  } else {
    document.getElementById('attachmentInfo').textContent = '';
  }
});

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64Data = reader.result.split(',')[1];
      resolve(base64Data);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function extractTextFromFile(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'txt') {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsText(file);
    });
  }
  if (ext === 'pdf') {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(it => it.str).join(" ") + "\n";
    }
    return text;
  }
  if (ext === 'docx') {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    return result.value;
  }
  return "[不支持的文件类型]";
}

async function sendMessage() {
  let q = document.getElementById("userInput").value.trim();
  if (!q && !selectedFile) {
    addMessage("系统提示", "请输入问题或选择文件");
    return;
  }
  if (!currentModel) {
    addMessage("系统提示", "请先选择模型");
    return;
  }

  document.getElementById("userInput").value = "";
  let userMessageContent = q;

  if (selectedFile && selectedFile.type.startsWith('image/')) {
    try {
      const base64Image = await fileToBase64(selectedFile);
      userMessageContent = [
        { type: "text", text: q },
        {
          type: "image_url",
          image_url: {
            url: `data:${selectedFile.type};base64,${base64Image}`
          }
        }
      ];
    } catch (err) {
      addMessage("系统提示", "图片处理失败：" + err.message);
      return;
    }
  } else if (selectedFile) {
    try {
      const fileText = await extractTextFromFile(selectedFile);
      userMessageContent = `${q}\n\n--- 上传文件：${selectedFile.name} ---\n${fileText}`;
    } catch (err) {
      userMessageContent = `${q}\n[附件：${selectedFile.name}（解析失败）]`;
    }
  }

  conversationHistory.push({
    role: "user",
    content: userMessageContent
  });

  addMessage("你", selectedFile ? `${q}\n[附件：${selectedFile.name}]` : q);
  addMessage(`【${currentModel.toUpperCase()}】`, "正在思考中...", true);

  try {
    let res = await fetch(API_CONFIG.url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + API_CONFIG.key
      },
      body: JSON.stringify({
        model: currentModel,
        messages: conversationHistory
      })
    });
    let data = await res.json();
    let reply = data.choices?.[0]?.message?.content || "请求失败，请检查网络或Key";

    const messages = messageBox.querySelectorAll('.message');
    const lastMessage = messages[messages.length - 1];
    lastMessage.querySelector('.ai-msg').textContent = reply;
    conversationHistory.push({ role: "assistant", content: reply });

  } catch (e) {
    const messages = messageBox.querySelectorAll('.message');
    const lastMessage = messages[messages.length - 1];
    lastMessage.querySelector('.ai-msg').textContent = "请求出错：" + e.toString();
  }

  selectedFile = null;
  document.getElementById('attachmentInfo').textContent = '';
  document.getElementById('fileInput').value = '';
}

function addMessage(sender, content, isPending = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message';
  
  const senderDiv = document.createElement('div');
  senderDiv.className = 'user-msg';
  senderDiv.textContent = sender;
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'ai-msg';
  contentDiv.textContent = content;
  
  messageDiv.appendChild(senderDiv);
  messageDiv.appendChild(contentDiv);
  messageBox.appendChild(messageDiv);
  
  messageBox.scrollTop = messageBox.scrollHeight;
}

function clearHistory() {
  conversationHistory = [];
  messageBox.innerHTML = `
    <div class="message">
      <div class="user-msg">系统提示</div>
      <div class="ai-msg">
        <div>请先选择模型；对话历史会自动保留，切换模型不影响原有历史记录。</div>
        <div style="margin-top:6px;">支持发送文本、<strong>TXT / PDF / Word</strong> 文档；左下角 <strong>📎 回形针可上传文件</strong>，<strong>仅 Gemini 2.0 Flash 支持图片识别</strong>。</div>
        <div style="margin-top:6px;">温馨提醒：上下文对话会持续累积，不清空将携带全部历史记录，消耗更多额度；<strong>GPT-4 费用较高，请谨慎使用</strong>。</div>
      </div>
    </div>
  `;
}

// ↓↓↓ 安卓兼容修复：把弹窗改成安卓能识别的写法 ↓↓↓
function showQA() {
  setTimeout(()=>{
    document.getElementById("firstModal").style.display = "flex";
  }, 100);
}

function closeFirstModal() {
  document.getElementById("firstModal").style.display = "none";
  setTimeout(showPassword, 200);
}

function showPassword() {
  let ans = prompt("请输入答案：我最喜欢的歌手？");
  if (ans && ans.trim() === "陶喆") {
    // 验证通过
  } else {
    alert("答案不正确，无法使用");
    window.close();
  }
}

window.onload = showQA;
</script>
</body>
</html>