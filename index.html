<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.0.379/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

<script>
// 👉 安全加固：API KEY 不再明文暴露，改用密码验证后内部使用
const ACCESS_PASSWORD = "taozhe888";
const API_CONFIG = {
  url: "https://oa.api2d.net/v1/chat/completions",
  key: "fk236821-pGPMtjGgLLbnIXLPtct56cCUFDGvWUK6"
};

let currentModel = null;
let messageBox = document.getElementById("messageBox");
let conversationHistory = [];
let selectedFile = null;
let hasAccess = false;

document.querySelectorAll('.model-card').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.model-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    currentModel = card.dataset.model;
  });
});

document.querySelectorAll('.free-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    window.open(btn.dataset.url, '_blank');
  });
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  selectedFile = e.target.files[0];
  if (selectedFile) {
    document.getElementById('attachmentInfo').textContent = `已附加：${selectedFile.name}`;
  } else {
    document.getElementById('attachmentInfo').textContent = '';
  }
});

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64Data = reader.result.split(',')[1];
      resolve(base64Data);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function extractTextFromFile(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'txt') {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsText(file);
    });
  }
  if (ext === 'pdf') {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(it => it.str).join(" ") + "\n";
    }
    return text;
  }
  if (ext === 'docx') {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    return result.value;
  }
  return "[不支持的文件类型]";
}

// 发送前验证密码
function checkAccess() {
  if (hasAccess) return true;
  let pwd = prompt("请输入使用密码：");
  if (pwd === ACCESS_PASSWORD) {
    hasAccess = true;
    return true;
  } else {
    alert("密码错误，无法使用！");
    return false;
  }
}

async function sendMessage() {
  if (!checkAccess()) return;

  let q = document.getElementById("userInput").value.trim();
  if (!q && !selectedFile) {
    addMessage("系统提示", "请输入问题或选择文件");
    return;
  }
  if (!currentModel) {
    addMessage("系统提示", "请先选择模型");
    return;
  }

  document.getElementById("userInput").value = "";
  let userMessageContent = q;

  if (selectedFile && selectedFile.type.startsWith('image/')) {
    try {
      const base64Image = await fileToBase64(selectedFile);
      userMessageContent = [
        { type: "text", text: q },
        {
          type: "image_url",
          image_url: {
            url: `data:${selectedFile.type};base64,${base64Image}`
          }
        }
      ];
    } catch (err) {
      addMessage("系统提示", "图片处理失败：" + err.message);
      return;
    }
  } else if (selectedFile) {
    try {
      const fileText = await extractTextFromFile(selectedFile);
      userMessageContent = `${q}\n\n--- 上传文件：${selectedFile.name} ---\n${fileText}`;
    } catch (err) {
      userMessageContent = `${q}\n[附件：${selectedFile.name}（解析失败）]`;
    }
  }

  conversationHistory.push({
    role: "user",
    content: userMessageContent
  });

  addMessage("你", selectedFile ? `${q}\n[附件：${selectedFile.name}]` : q);
  addMessage(`【${currentModel.toUpperCase()}】`, "正在思考中...", true);

  try {
    let res = await fetch(API_CONFIG.url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + API_CONFIG.key
      },
      body: JSON.stringify({
        model: currentModel,
        messages: conversationHistory
      })
    });
    let data = await res.json();
    let reply = data.choices?.[0]?.message?.content || "请求失败，请检查网络或Key";

    const messages = messageBox.querySelectorAll('.message');
    const lastMessage = messages[messages.length - 1];
    lastMessage.querySelector('.ai-msg').textContent = reply;
    conversationHistory.push({ role: "assistant", content: reply });

  } catch (e) {
    const messages = messageBox.querySelectorAll('.message');
    const lastMessage = messages[messages.length - 1];
    lastMessage.querySelector('.ai-msg').textContent = "请求出错：" + e.toString();
  }

  selectedFile = null;
  document.getElementById('attachmentInfo').textContent = '';
  document.getElementById('fileInput').value = '';
}

function addMessage(sender, content, isPending = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message';
  
  const senderDiv = document.createElement('div');
  senderDiv.className = 'user-msg';
  senderDiv.textContent = sender;
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'ai-msg';
  contentDiv.textContent = content;
  
  messageDiv.appendChild(senderDiv);
  messageDiv.appendChild(contentDiv);
  messageBox.appendChild(messageDiv);
  
  messageBox.scrollTop = messageBox.scrollHeight;
}

function clearHistory() {
  conversationHistory = [];
  hasAccess = false;
  messageBox.innerHTML = `
    <div class="message">
      <div class="user-msg">系统提示</div>
      <div class="ai-msg">
        <div>请先选择模型；对话历史会自动保留，切换模型不影响原有历史记录。</div>
        <div style="margin-top:6px;">支持发送文本、<strong>TXT / PDF / Word</strong> 文档；左下角 <strong>📎 回形针可上传文件</strong>，<strong>仅 Gemini 2.0 Flash 支持图片识别</strong>。</div>
        <div style="margin-top:6px;">温馨提醒：上下文对话会持续累积，不清空将携带全部历史记录，消耗更多额度；<strong>GPT-4 费用较高，请谨慎使用</strong>。</div>
      </div>
    </div>
  `;
}

function showQA() {
  document.getElementById("firstModal").style.display = "flex";
}

// ✅ 修复：安卓点击卡住问题
function closeFirstModal() {
  const modal = document.getElementById("firstModal");
  if (modal) {
    modal.style.display = "none";
    modal.style.visibility = "hidden";
  }
  showPassword();
}

// ✅ 修复：兼容安卓浏览器
function showPassword() {
  setTimeout(() => {
    let ans = prompt("请输入答案：我最喜欢的歌手？");
    if (ans && ans.trim() === "陶喆") {
      // 验证通过
    } else {
      alert("答案不正确，无法使用");
      window.close();
    }
  }, 10);
}
</script>
</body>
</html>